<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OCR Trainer</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
      }
      .wrapper {
        display: flex;
        flex-direction: row;
        justify-content: stretch;
        align-items: stretch;
      }
      #container {
        position: relative;
        display: flex;
        max-width: 100vw;
        margin: 0 15rem 0 0;
      }
      #document {
        width: 100%;
        display: block;
      }
      .box {
        position: absolute;
        background-color: rgba(255, 0, 0, 0.12);
        border: 0.0625rem solid red;
        box-sizing: border-box;
      }
      .box.selected {
        border: 0.125rem solid black;
      }

      .ui-control-panel {
        position: fixed;
        top: 1.5rem;
        left: 1.5rem;
        z-index: 1000;
        background-color: rgba(255, 255, 255, 0.66);
        border-radius: 0.25rem;
        padding: 0.25rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
        font-size: 0.75rem;
        line-height: 1.125rem;
        transition: background-color 0.2s;
      }
      .ui-control-panel:hover {
        background-color: rgba(255, 255, 255, 1);
      }

      .ui-control-panel span {
        padding: 0.25rem;
        display: none;
      }
      .ui-control-panel:hover span {
        display: flex;
      }

      #zoom-control {
        -webkit-appearance: none;
        width: 100%;
        height: 0.125rem;
        background: #ddd;
        outline: none;
        border-radius: 0.125rem;
      }

      #zoom-control::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 1rem;
        height: 1rem;
        background: #5500ff;
        cursor: pointer;
        border-radius: 50%;
      }

      #zoom-control::-moz-range-thumb {
        width: 1rem;
        height: 1rem;
        background: #5500ff;
        cursor: pointer;
        border-radius: 50%;
      }
      #overpanel {
        position: fixed;
        right: 0;
        top: 0;
        width: 15rem;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        background: blur(0.75rem);
        border-left: 0.0625rem solid rgba(0, 0, 0, 0.12);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        transition: background-color 0.2s;
      }
      #overpanel:hover {
        background-color: rgba(255, 255, 255, 1);
      }

      #description-form {
        padding: 0.75rem;
      }
      .input-group {
        align-items: center;
        display: flex;
        flex-direction: row;
        margin-bottom: 0.75rem;
        position: relative;
      }
      .correction {
        background-color: rgba(255, 255, 0, 0.12);
        color: inherit;
        font-size: 0.75rem;
        line-height: 1.5rem;
        padding: 0.375rem 0.75rem;
        width: calc(100% - 1.5rem);
      }
      .correction:focus {
        border: 0.0625rem solid rgba(0, 0, 0, 1);
      }
      .ignore {
        border: none;
        background: none;
      }

      header,
      footer {
        background-color: white;
        padding: 0.375rem 0.75rem;
        position: sticky;
        width: calc(100% - 1.5rem);
        right: 0;
        left: auto;
        z-index: 1;
      }
      header {
        top: 0;
        border-bottom: 0.0625rem solid rgba(0, 0, 0, 0.12);
      }
      footer {
        bottom: 0;
        border-top: 0.0625rem solid rgba(0, 0, 0, 0.12);
      }
      h2 {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.5rem;
        outline: none;
        margin: 0;
      }
      input,
      button {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        border: 0.0625rem solid rgba(0, 0, 0, 0.12);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
        opacity: 0.7;
        transition: opacity 0.2s border 0.2s;
      }
      input:hover,
      button:hover {
        opacity: 1;
      }
      #submit-button {
        background-color: #5500ff;
        color: white;
        font-size: 0.625rem;
        font-weight: 900;
        line-height: 1.125rem;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="ui-control-panel">
      <input
        type="range"
        id="zoom-control"
        min="0.5"
        max="2"
        step="0.1"
        value="1"
      />
      <span>Slide to change zoom</span>
    </div>
    <div class="wrapper">
      <div id="container">
        <img id="document" src="record.jpg" alt="Document" />
      </div>
      <div id="overpanel">
        <header>
          <h2>Text Extractions</h2>
        </header>
        <form id="description-form"></form>
        <footer>
          <button type="button" id="submit-button">Validate</button>
        </footer>
      </div>
    </div>

    <script>
      const img = document.getElementById("document");
      const container = document.getElementById("container");
      const zoomControl = document.getElementById("zoom-control");
      const overpanel = document.getElementById("overpanel");
      const descriptionForm = document.getElementById("description-form");
      const submitButton = document.getElementById("submit-button");
      let currentSelectedBox = null;

      submitButton.addEventListener("click", handleSubmit);

      function drawBoxes(ocrData, scale) {
        container.querySelectorAll(".box").forEach((box) => box.remove());
        descriptionForm.innerHTML = "";

        ocrData.textAnnotations.forEach((item, index) => {
          const vertices = item.boundingPoly.vertices;
          const x = vertices[0].x * scale;
          const y = vertices[0].y * scale;
          const width = (vertices[1].x - vertices[0].x) * scale;
          const height = (vertices[2].y - vertices[0].y) * scale;

          const box = document.createElement("div");
          box.className = "box";
          box.style.left = `${x / 16}rem`;
          box.style.top = `${y / 16}rem`;
          box.style.width = `${width / 16}rem`;
          box.style.height = `${height / 16}rem`;

          box.addEventListener("click", () => {
            selectBox(box, item.description, index);
          });

          container.appendChild(box);

          // Create input-group div
          const inputGroup = document.createElement("div");
          inputGroup.className = "input-group";

          const input = document.createElement("input");
          input.type = "text";
          input.value = item.description;
          input.className = "correction";
          input.dataset.index = index;
          input.dataset.originalValue = item.description; // Store the original value
          input.addEventListener("focus", () => {
            selectBox(box, item.description, index);
          });
          // Create ignore button
          const ignoreButton = document.createElement("button");
          ignoreButton.type = "button";
          ignoreButton.className = "ignore";
          ignoreButton.textContent = "ðŸ™ˆ";
          ignoreButton.addEventListener("click", () => {
            input.value = "ignore";
          });

          // Append input and button to input-group
          inputGroup.appendChild(input);
          inputGroup.appendChild(ignoreButton);

          // Append input-group to descriptionForm
          descriptionForm.appendChild(inputGroup);
        });
      }

      function selectBox(box, description, index) {
        if (currentSelectedBox) {
          currentSelectedBox.classList.remove("selected");
        }
        box.classList.add("selected");
        currentSelectedBox = box;

        const input = descriptionForm.querySelector(
          `input[data-index="${index}"]`
        );
        if (input) {
          input.scrollIntoView({ behavior: "smooth", block: "center" });
          input.focus();
        } else {
          console.error(`Input element with data-index="${index}" not found.`);
        }
      }

      function handleSubmit() {
        const formData = new FormData(descriptionForm);
        const data = [];

        // Debug: Log formData entries
        console.log("FormData entries:");
        formData.forEach((value, key) => {
          console.log(`Key: ${key}, Value: ${value}`);
        });

        // Iterate over input elements directly if formData is empty
        const inputs = descriptionForm.querySelectorAll("input[data-index]");
        inputs.forEach((input) => {
          const index = input.dataset.index;
          const originalValue = input.dataset.originalValue;
          const value = input.value;

          const item = {
            index: index,
            originalDescription: originalValue,
            correctedDescription: value !== originalValue ? value : undefined,
          };

          console.log("Processing item:", item); // Debugging log
          data.push(item);
        });

        console.log("Submitted data:", JSON.stringify(data, null, 2));
        // Send corrected data to the server
      }

      img.onload = function () {
        const imgWidth = img.naturalWidth;
        const imgHeight = img.naturalHeight;
        const scaleX = img.clientWidth / imgWidth;
        const scaleY = scaleX;

        fetch("ocr_response.json")
          .then((response) => response.json())
          .then((ocrData) => {
            console.log("OCR data loaded:", ocrData);
            drawBoxes(ocrData, scaleX);

            zoomControl.addEventListener("input", function () {
              const zoomLevel = parseFloat(zoomControl.value);
              img.style.transform = `scale(${zoomLevel})`;
              img.style.transformOrigin = "top left";
              drawBoxes(ocrData, scaleX * zoomLevel);
            });
          })
          .catch((error) => console.error("Error loading OCR data:", error));
      };
    </script>
  </body>
</html>
